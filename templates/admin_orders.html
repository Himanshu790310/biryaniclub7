{% extends "base.html" %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-5 mb-2">
                        <i class="fas fa-list-alt text-primary"></i> Order Management
                    </h1>
                    <p class="text-muted">Manage and track all orders</p>
                </div>
                <div>
                    <a href="{{ url_for('admin') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2 align-items-center">
                        <span class="fw-bold me-3">Filter by Status:</span>
                        <a href="{{ url_for('admin_orders', status='all') }}" 
                           class="btn btn-{% if status_filter == 'all' %}primary{% else %}outline-primary{% endif %} btn-sm">
                            All Orders
                        </a>
                        <a href="{{ url_for('admin_orders', status='pending') }}" 
                           class="btn btn-{% if status_filter == 'pending' %}warning{% else %}outline-warning{% endif %} btn-sm">
                            Pending
                        </a>
                        <a href="{{ url_for('admin_orders', status='confirmed') }}" 
                           class="btn btn-{% if status_filter == 'confirmed' %}info{% else %}outline-info{% endif %} btn-sm">
                            Confirmed
                        </a>
                        <a href="{{ url_for('admin_orders', status='preparing') }}" 
                           class="btn btn-{% if status_filter == 'preparing' %}primary{% else %}outline-primary{% endif %} btn-sm">
                            Preparing
                        </a>
                        <a href="{{ url_for('admin_orders', status='out_for_delivery') }}" 
                           class="btn btn-{% if status_filter == 'out_for_delivery' %}secondary{% else %}outline-secondary{% endif %} btn-sm">
                            Out for Delivery
                        </a>
                        <a href="{{ url_for('admin_orders', status='delivered') }}" 
                           class="btn btn-{% if status_filter == 'delivered' %}success{% else %}outline-success{% endif %} btn-sm">
                            Delivered
                        </a>
                        <a href="{{ url_for('admin_orders', status='cancelled') }}" 
                           class="btn btn-{% if status_filter == 'cancelled' %}danger{% else %}outline-danger{% endif %} btn-sm">
                            Cancelled
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Orders List -->
    <div class="row">
        <div class="col-12">
            {% if orders %}
            {% for order in orders %}
            <div class="card mb-3">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center gap-3">
                                <h5 class="mb-0">Order #{{ order.order_number }}</h5>
                                <span class="badge bg-{% if order.status == 'pending' %}warning{% elif order.status == 'confirmed' %}info{% elif order.status == 'preparing' %}primary{% elif order.status == 'out_for_delivery' %}secondary{% elif order.status == 'delivered' %}success{% else %}danger{% endif %} fs-6">
                                    {{ order.status|title|replace('_', ' ') }}
                                </span>
                                <span class="badge bg-{% if order.payment_method == 'cash' %}warning{% else %}primary{% endif %}">
                                    {% if order.payment_method == 'cash' %}Cash on Delivery{% else %}UPI Payment{% endif %}
                                </span>
                                {% if order.is_guest_order %}
                                <span class="badge bg-secondary">Guest Order</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="text-muted small">
                                <small data-timestamp="{{ order.created_at.isoformat() }}">{{ order.created_at_ist.strftime('%d %b %Y, %I:%M %p IST') }}</small>
                            </div>
                            <div class="fw-bold text-success fs-5">₹{{ "%.0f"|format(order.total_amount) }}</div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Customer Info -->
                        <div class="col-md-6 mb-3">
                            <h6><i class="fas fa-user"></i> Customer Information</h6>
                            <div class="ms-3">
                                <div><strong>Name:</strong> {{ order.customer_name }}</div>
                                <div><strong>Phone:</strong> 
                                    <a href="tel:{{ order.customer_phone }}" class="text-decoration-none">
                                        {{ order.customer_phone }}
                                    </a>
                                </div>
                                <div><strong>Address:</strong></div>
                                <div class="text-muted small">{{ order.customer_address }}</div>
                            </div>
                        </div>

                        <!-- Order Items -->
                        <div class="col-md-6 mb-3">
                            <h6><i class="fas fa-shopping-bag"></i> Order Items</h6>
                            <div class="ms-3">
                                {% for item in order.order_items %}
                                <div class="d-flex justify-content-between mb-1">
                                    <span>{{ item.menu_item.name }} × {{ item.quantity }}</span>
                                    <span>₹{{ "%.0f"|format(item.total_price) }}</span>
                                </div>
                                {% endfor %}
                                {% if order.discount > 0 %}
                                <div class="d-flex justify-content-between mb-1 text-success">
                                    <span>Discount</span>
                                    <span>-₹{{ "%.0f"|format(order.discount) }}</span>
                                </div>
                                {% endif %}
                                <hr class="my-2">
                                <div class="d-flex justify-content-between fw-bold">
                                    <span>Total</span>
                                    <span>₹{{ "%.0f"|format(order.total_amount) }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Status -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="alert alert-{% if order.payment_status == 'confirmed' %}success{% elif order.payment_status == 'pending' %}warning{% else %}danger{% endif %} py-2">
                                <i class="fas fa-{% if order.payment_status == 'confirmed' %}check-circle{% elif order.payment_status == 'pending' %}clock{% else %}times-circle{% endif %}"></i>
                                <strong>Payment Status:</strong> {{ order.payment_status|title }}
                                {% if order.payment_method == 'upi' and order.payment_status == 'pending' %}
                                - Customer needs to confirm UPI payment
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Order Actions -->
                    {% if order.status in ['pending', 'confirmed', 'preparing', 'out_for_delivery'] %}
                    <div class="row">
                        <div class="col-12">
                            <form action="{{ url_for('update_order_status') }}" method="POST" class="d-inline">
                                <input type="hidden" name="order_id" value="{{ order.id }}">
                                <div class="d-flex gap-2 align-items-center">
                                    <label class="form-label mb-0">Update Status:</label>
                                    <select name="status" class="form-select w-auto">
                                        <option value="{{ order.status }}" selected>{{ order.status|title|replace('_', ' ') }}</option>
                                        {% if order.status == 'pending' %}
                                        <option value="confirmed">Confirm Order</option>
                                        <option value="cancelled">Cancel Order</option>
                                        {% elif order.status == 'confirmed' %}
                                        <option value="preparing">Start Preparing</option>
                                        <option value="cancelled">Cancel Order</option>
                                        {% elif order.status == 'preparing' %}
                                        <option value="out_for_delivery">Out for Delivery</option>
                                        {% elif order.status == 'out_for_delivery' %}
                                        <option value="delivered">Mark as Delivered</option>
                                        {% endif %}
                                    </select>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Update
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% else %}
            <!-- No Orders -->
            <div class="card">
                <div class="card-body text-center py-5">
                    <div class="fs-1 text-muted mb-3">
                        <i class="fas fa-inbox"></i>
                    </div>
                    <h4>No orders found</h4>
                    <p class="text-muted">
                        {% if status_filter != 'all' %}
                            No orders with status "{{ status_filter }}" found.
                        {% else %}
                            No orders have been placed yet.
                        {% endif %}
                    </p>
                    {% if status_filter != 'all' %}
                    <a href="{{ url_for('admin_orders') }}" class="btn btn-primary">
                        <i class="fas fa-list"></i> View All Orders
                    </a>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Real-time updates every 15 seconds for admin panel
    setInterval(function() {
        location.reload();
    }, 15000);

    // Confirmation for critical actions
    document.querySelectorAll('select[name="status"]').forEach(select => {
        select.addEventListener('change', function() {
            const newStatus = this.value;
            const orderNumber = this.closest('.card').querySelector('h5').textContent;

            if (newStatus === 'cancelled') {
                if (!confirm(`Are you sure you want to cancel ${orderNumber}? This action cannot be undone.`)) {
                    this.value = this.querySelector('option[selected]').value;
                    return;
                }
            } else if (newStatus === 'delivered') {
                if (!confirm(`Mark ${orderNumber} as delivered? This will complete the order.`)) {
                    this.value = this.querySelector('option[selected]').value;
                    return;
                }
            }
        });
    });

    // Add notification sound and title updates for new orders
    const pendingCount = {{ orders|selectattr("status", "equalto", "pending")|list|length }};
    if (pendingCount > 0) {
        document.title = `(${pendingCount}) New Orders - Admin Panel`;

        // Flash title every 2 seconds for attention
        let titleFlash = setInterval(() => {
            document.title = document.title.startsWith('🔔') ? 
                `(${pendingCount}) New Orders - Admin Panel` : 
                `🔔 (${pendingCount}) NEW ORDERS - Admin Panel`;
        }, 2000);
    }

    // Function to convert UTC timestamp to IST
    function convertToIST(timestamp) {
        const date = new Date(timestamp);
        const options = {
            timeZone: 'Asia/Kolkata',
            year: 'numeric', month: 'short', day: 'numeric',
            hour: '2-digit', minute: '2-digit', second: '2-digit',
            hour12: true
        };
        return date.toLocaleString('en-IN', options);
    }

    // Update timestamps to IST on page load
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('small[data-timestamp]').forEach(small => {
            const utcTimestamp = small.getAttribute('data-timestamp');
            small.textContent = convertToIST(utcTimestamp);
        });
    });
</script>
{% endblock %}